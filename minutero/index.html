<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcriber Client</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2, h3 { color: #0056b3; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .transcription-instance { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-top: 15px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-top: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        button.remove-btn { background-color: #dc3545; }
        button.remove-btn:hover { background-color: #c82333; }
        input[type="text"], select { padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-right: 10px; margin-top: 5px; }
        .log-area, .transcription-area { background-color: #e9e9e9; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
        .unified-transcription { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; line-height: 1.6; border: 2px solid #007bff; }
        .status-message { margin-top: 10px; font-weight: bold; }
        .error-message { color: red; }
        .success-message { color: green; }
        .source-label { font-weight: bold; color: #0056b3; }
    </style>
</head>
<body>
    <h1>Cliente de Transcripci√≥n de Audio</h1>

    <div class="container">
        <h2>Gesti√≥n de Modelos</h2>
        <label for="modelSelect">Modelo Whisper:</label>
        <select id="modelSelect">
            <option value="small">Peque√±o</option>
            <option value="medium">Mediano</option>
            <option value="large-v3">Grande (lento, - error)</option>
            <option value="large-v3-turbo">Grande (r√°pido, + error)</option>
        </select>
        <button id="loadModelBtn">Cargar Modelo</button>
        <p class="status-message" id="modelStatus"></p>
        <h3>Capacidades del Modelo Actual</h3>
        <pre class="log-area" id="modelCapabilities">El modelo cargado aparecer√° aqu√≠.</pre>
    </div>
    
    <div class="container">
        <h2>Fuentes de Transcripci√≥n</h2>
        <button id="addSourceBtn">‚ûï A√±adir Fuente</button>
        <div id="transcriptionInstances"></div>
    </div>

    <div class="container">
        <h2>Transcripci√≥n Unificada en Tiempo Real</h2>
        <div class="unified-transcription" id="unifiedTranscription">Las transcripciones de todas las fuentes aparecer√°n aqu√≠ intercaladas...</div>
        <button id="clearTranscriptionBtn">üóëÔ∏è Limpiar Transcripci√≥n</button>
    </div>
    
    <div class="container">
        <h2>Guardar Transcripciones</h2>
        <button id="saveTranscriptionBtn">üíæ Guardar Transcripci√≥n Unificada</button>
        <p>Esto guardar√° el contenido de la transcripci√≥n unificada en archivos .txt y .md.</p>
    </div>

    <div class="container">
        <h2>Logs y Mensajes del Sistema</h2>
        <div class="log-area" id="logOutput"></div>
    </div>
    
    <template id="transcriptionInstanceTemplate">
        <div class="transcription-instance">
            <button class="remove-btn" style="float: right;">‚úñ</button>
            <h3>Nueva Fuente</h3>
            <div>
                <label>Etiqueta de Fuente: <input type="text" class="sourceTagInput" placeholder="ej. microfono_principal"></label>
                <label>Tipo: 
                    <select class="sourceTypeSelect">
                        <option value="microphone" selected>Micr√≥fono</option>
                        <option value="screen">Sonido del Sistema</option>
                        <option value="file">Archivo WAV</option>
                    </select>
                </label>
                <label class="filePathLabel" style="display: none;">Ruta Archivo: <input type="text" class="filePathInput" placeholder="/path/to/audio.wav"></label>
            </div>
            <div>
                <label>Idioma: <input type="text" class="languageInput" value="es" placeholder="ej. en, es"></label>
                <label>Prompt Inicial: <input type="text" class="promptInput" placeholder="ej. El orador habla sobre..."></label>
            </div>
            <br>
            <button class="startBtn">Iniciar Transcripci√≥n</button>
            <button class="stopBtn" disabled>Detener Transcripci√≥n</button>
            <p class="status-message transcriptionStatus"></p>
        </div>
    </template>

    <script>
        const API_BASE_URL = "http://localhost:8000";
        let activeWebsockets = {};
        let instanceCounter = 0;
        let unifiedTranscriptionText = "";
        let currentSpeaker = null;

        const logOutput = document.getElementById('logOutput');
        const modelSelect = document.getElementById('modelSelect');
        const loadModelBtn = document.getElementById('loadModelBtn');
        const modelStatus = document.getElementById('modelStatus');
        const modelCapabilities = document.getElementById('modelCapabilities');
        const unifiedTranscription = document.getElementById('unifiedTranscription');

        function appendLog(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (type === 'error') p.style.color = 'red';
            if (type === 'success') p.style.color = 'green';
            logOutput.appendChild(p);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function setStatus(element, message, type = 'info') {
            element.textContent = message;
            element.className = `status-message ${type}-message`;
        }

        function addToUnifiedTranscription(sourceTag, text) {
            if (!text || text.trim() === '') return;
            
            // Si el hablante actual cambi√≥, a√±adir nueva l√≠nea con etiqueta
            if (currentSpeaker !== sourceTag) {
                if (unifiedTranscriptionText !== "") {
                    unifiedTranscriptionText += "\n";
                }
                unifiedTranscriptionText += `${sourceTag}: `;
                currentSpeaker = sourceTag;
            }
            
            // A√±adir el texto transcrito
            unifiedTranscriptionText += text;
            
            // Actualizar la visualizaci√≥n
            updateUnifiedDisplay();
        }

        function updateUnifiedDisplay() {
            unifiedTranscription.textContent = unifiedTranscriptionText;
            unifiedTranscription.scrollTop = unifiedTranscription.scrollHeight;
        }

        async function fetchModelCapabilities() {
            modelCapabilities.textContent = "Carga un modelo para ver sus capacidades.";
        }
        
        // --- Gesti√≥n de Modelos ---
        loadModelBtn.addEventListener('click', async () => {
            const modelSize = modelSelect.value;
            setStatus(modelStatus, `Cargando modelo Whisper '${modelSize}'... Esto puede tardar si se necesita descargar.`, 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/models/load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_name: "WhisperModel",
                        model_config_kwargs: { model_size: modelSize }
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    setStatus(modelStatus, result.message, 'success');
                    appendLog(result.message, 'success');
                    const capsResponse = await fetch(`${API_BASE_URL}/models/capabilities/WhisperModel`);
                    const caps = await capsResponse.json();
                    modelCapabilities.textContent = JSON.stringify(caps, null, 2);
                } else {
                    setStatus(modelStatus, `Error: ${result.detail}`, 'error');
                    appendLog(`Error al cargar modelo: ${result.detail}`, 'error');
                }
            } catch (error) {
                setStatus(modelStatus, `Error de conexi√≥n: ${error.message}`, 'error');
                appendLog(`Error de conexi√≥n al cargar modelo: ${error.message}`, 'error');
            }
        });

        // --- Limpiar transcripci√≥n unificada ---
        document.getElementById('clearTranscriptionBtn').addEventListener('click', () => {
            unifiedTranscriptionText = "";
            currentSpeaker = null;
            updateUnifiedDisplay();
            appendLog("Transcripci√≥n unificada limpiada.", "info");
        });

        // --- Gesti√≥n de Instancias de Transcripci√≥n ---
        document.getElementById('addSourceBtn').addEventListener('click', () => {
            const template = document.getElementById('transcriptionInstanceTemplate');
            const clone = template.content.cloneNode(true);
            const instanceId = `instance-${instanceCounter++}`;
            
            const instanceDiv = clone.querySelector('.transcription-instance');
            instanceDiv.id = instanceId;
            instanceDiv.querySelector('.sourceTagInput').value = `audio_${instanceCounter}`;

            document.getElementById('transcriptionInstances').appendChild(clone);
            
            setupInstanceEventListeners(instanceId);
        });

        function setupInstanceEventListeners(instanceId) {
            const instanceDiv = document.getElementById(instanceId);

            instanceDiv.querySelector('.remove-btn').addEventListener('click', () => {
                stopTranscription(instanceId);
                instanceDiv.remove();
                delete activeWebsockets[instanceId];
                appendLog(`Instancia ${instanceId} eliminada.`);
            });

            instanceDiv.querySelector('.sourceTypeSelect').addEventListener('change', (e) => {
                const filePathLabel = instanceDiv.querySelector('.filePathLabel');
                filePathLabel.style.display = e.target.value === 'file' ? 'inline-block' : 'none';
            });
            
            instanceDiv.querySelector('.startBtn').addEventListener('click', () => startTranscription(instanceId));
            instanceDiv.querySelector('.stopBtn').addEventListener('click', () => stopTranscription(instanceId));
        }

        async function startTranscription(instanceId) {
            const instanceDiv = document.getElementById(instanceId);
            const sourceTag = instanceDiv.querySelector('.sourceTagInput').value;
            if (!sourceTag) {
                alert("Por favor, introduce una etiqueta de fuente √∫nica.");
                return;
            }

            if (activeWebsockets[instanceId]) {
                activeWebsockets[instanceId].close();
            }

            const sourceType = instanceDiv.querySelector('.sourceTypeSelect').value;
            const filePath = instanceDiv.querySelector('.filePathInput').value;
            const language = instanceDiv.querySelector('.languageInput').value;
            const initialPrompt = instanceDiv.querySelector('.promptInput').value;

            const startBtn = instanceDiv.querySelector('.startBtn');
            const stopBtn = instanceDiv.querySelector('.stopBtn');
            const statusEl = instanceDiv.querySelector('.transcriptionStatus');

            const wsUrl = `${API_BASE_URL.replace('http', 'ws')}/transcribe/ws/${sourceTag}?language=${language}&initial_prompt=${encodeURIComponent(initialPrompt || '')}`;
            const websocket = new WebSocket(wsUrl);
            activeWebsockets[instanceId] = websocket;

            websocket.onopen = () => {
                appendLog(`Conectado al WebSocket para ${sourceTag}.`, 'success');
                setStatus(statusEl, `Conectado. Enviando configuraci√≥n...`, 'info');
                startBtn.disabled = true;
                stopBtn.disabled = false;

                const startMessage = {
                    action: "start",
                    source_type: sourceType,
                    source_tag: sourceTag,
                };
                if (sourceType === "file") {
                    startMessage.file_path = filePath;
                }
                websocket.send(JSON.stringify(startMessage));
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.status) {
                    setStatus(statusEl, data.message, data.status === "started" ? "success" : "info");
                    appendLog(`Status(${sourceTag}): ${data.message}`);
                } else if (data.text !== undefined) {
                    // A√±adir a la transcripci√≥n unificada en lugar de individual
                    addToUnifiedTranscription(sourceTag, data.text + " ");
                }
            };

            websocket.onerror = (event) => {
                appendLog(`Error en WebSocket (${sourceTag}): Error desconocido`, 'error');
                setStatus(statusEl, "Error en la conexi√≥n WebSocket.", 'error');
                cleanupUi(instanceId);
            };

            websocket.onclose = (event) => {
                appendLog(`WebSocket cerrado para ${sourceTag}. C√≥digo: ${event.code}`, 'info');
                setStatus(statusEl, `Desconectado.`, 'info');
                cleanupUi(instanceId);
            };
        }
        
        function stopTranscription(instanceId) {
            const websocket = activeWebsockets[instanceId];
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ action: "stop" }));
                websocket.close();
            }
            cleanupUi(instanceId);
        }

        function cleanupUi(instanceId) {
            const instanceDiv = document.getElementById(instanceId);
            if(instanceDiv) {
                instanceDiv.querySelector('.startBtn').disabled = false;
                instanceDiv.querySelector('.stopBtn').disabled = true;
            }
            delete activeWebsockets[instanceId];
        }
        
        // --- Guardar Transcripci√≥n ---
        document.getElementById('saveTranscriptionBtn').addEventListener('click', () => {
            if (!unifiedTranscriptionText || unifiedTranscriptionText.trim() === '') {
                alert("No hay transcripci√≥n unificada para guardar.");
                return;
            }

            const timestamp = new Date().toLocaleString();
            let textContent = `Transcripci√≥n unificada guardada el ${timestamp}\n\n`;
            textContent += `========================================\n`;
            textContent += `TRANSCRIPCI√ìN INTERCALADA\n`;
            textContent += `========================================\n\n`;
            textContent += unifiedTranscriptionText;

            let markdownContent = `# Transcripci√≥n Unificada\n*Guardado el ${timestamp}*\n\n---\n\n`;
            markdownContent += `## Transcripci√≥n Intercalada\n\n`;
            markdownContent += `\`\`\`\n${unifiedTranscriptionText}\n\`\`\`\n`;
            
            downloadFile('transcripcion_unificada.txt', textContent, 'text/plain');
            downloadFile('transcripcion_unificada.md', markdownContent, 'text/markdown');
            appendLog("Archivos de transcripci√≥n unificada generados para descarga.", "success");
        });

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            fetchModelCapabilities();
        });
    </script>
</body>
</html>